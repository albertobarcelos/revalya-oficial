# Cursor Rules - Revalya Financial System

## ğŸ¯ Contexto do Projeto

VocÃª estÃ¡ trabalhando no **Revalya**, um sistema financeiro multi-tenant completo construÃ­do com:
- React 18 + TypeScript + Vite
- Supabase (PostgreSQL + Edge Functions)
- Shadcn/UI + Tailwind CSS
- TanStack Query + Zustand

## ğŸ” Regras de SeguranÃ§a Multi-Tenant (CRÃTICO)

### 1. Sempre Validar Acesso
- TODOS os componentes devem usar `useTenantAccessGuard()` antes de acessar dados
- TODAS as queries devem incluir `tenant_id` na query key
- TODAS as mutations devem incluir `tenant_id` nos dados

### 2. PadrÃ£o de Query Segura
```typescript
const query = useSecureTenantQuery({
  queryKey: ['resource', currentTenant?.id, filters],
  queryFn: async () => {
    await supabase.rpc('set_tenant_context_simple', {
      p_tenant_id: currentTenant.id
    });
    return fetchData();
  },
  enabled: hasAccess && !!currentTenant?.id
});
```

### 3. PadrÃ£o de Mutation Segura
```typescript
const mutation = useSecureTenantMutation({
  mutationFn: async (data) => {
    await supabase.rpc('set_tenant_context_simple', {
      p_tenant_id: currentTenant.id
    });
    return createResource({ ...data, tenant_id: currentTenant.id });
  }
});
```

## ğŸ“ ConvenÃ§Ãµes de CÃ³digo

### Nomenclatura
- **JavaScript/TypeScript**: `camelCase` para variÃ¡veis/funÃ§Ãµes, `PascalCase` para componentes
- **Python**: `snake_case` para variÃ¡veis/funÃ§Ãµes, `PascalCase` para classes
- **Constantes**: `UPPER_SNAKE_CASE`

### ComentÃ¡rios
- **Idioma**: Sempre em **portuguÃªs-BR**
- **AIDEV-NOTE**: ObrigatÃ³rio em operaÃ§Ãµes crÃ­ticas de seguranÃ§a
- Exemplo:
```typescript
// AIDEV-NOTE: ConfiguraÃ§Ã£o obrigatÃ³ria de contexto de tenant
// Garante isolamento de dados entre tenants
await supabase.rpc('set_tenant_context_simple', {
  p_tenant_id: currentTenant.id
});
```

### Query Keys
- Formato: `['resource', tenant_id, ...params]`
- Exemplo: `['charges', tenantId, { status: 'pending' }]`

## ğŸ¨ PadrÃµes de Componentes

### Template de Componente
```typescript
interface ComponentProps {
  // Props tipadas
}

export function Component({ ...props }: ComponentProps) {
  // 1. Hooks de seguranÃ§a
  const { hasAccess, currentTenant } = useTenantAccessGuard();
  
  // 2. Estados e queries
  const [state, setState] = useState();
  const query = useSecureTenantQuery({...});
  
  // 3. Callbacks
  const handleAction = useCallback(() => {
    // LÃ³gica
  }, [dependencies]);
  
  // 4. Early returns
  if (!hasAccess) return <AccessDenied />;
  
  // 5. Render
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
    >
      {/* ConteÃºdo */}
    </motion.div>
  );
}
```

## ğŸš¨ ValidaÃ§Ãµes ObrigatÃ³rias

### Antes de Criar/Modificar CÃ³digo

1. âœ… Componente usa `useTenantAccessGuard()`?
2. âœ… Query inclui `tenant_id` na query key?
3. âœ… Mutation inclui `tenant_id` nos dados?
4. âœ… Contexto de tenant configurado antes de operaÃ§Ãµes?
5. âœ… ComentÃ¡rios em portuguÃªs-BR?
6. âœ… AIDEV-NOTE em operaÃ§Ãµes crÃ­ticas?
7. âœ… Sem uso de `any` sem justificativa?
8. âœ… Erros tratados e logados?

## ğŸ“ Estrutura de Pastas

- `src/components/` - Componentes React
- `src/hooks/` - React Hooks (templates em `hooks/templates/`)
- `src/services/` - ServiÃ§os de negÃ³cio
- `src/types/` - TypeScript types
- `src/utils/` - FunÃ§Ãµes utilitÃ¡rias
- `src/lib/` - Bibliotecas e configuraÃ§Ãµes
- `src/pages/` - PÃ¡ginas da aplicaÃ§Ã£o
- `src/core/` - Core do sistema (auth, security, tenant, state)

## ğŸ”§ Funcionalidades Principais

1. **Dashboard Financeiro** - MÃ©tricas em tempo real
2. **GestÃ£o de Contratos** - Contratos digitais
3. **Faturamento** - Kanban visual com geraÃ§Ã£o automÃ¡tica
4. **ReconciliaÃ§Ã£o BancÃ¡ria** - IntegraÃ§Ã£o ASAAS
5. **IntegraÃ§Ãµes** - ASAAS, WhatsApp, Evolution API

## âš ï¸ NUNCA Fazer

- âŒ Criar queries sem validaÃ§Ã£o de tenant
- âŒ Usar `any` sem justificativa
- âŒ Escrever comentÃ¡rios em inglÃªs
- âŒ Modificar migrations sem permissÃ£o
- âŒ Alterar templates de seguranÃ§a sem revisÃ£o
- âŒ Criar RLS policies sem validaÃ§Ã£o de tenant_id

## âœ… SEMPRE Fazer

- âœ… Validar acesso com `useTenantAccessGuard()`
- âœ… Incluir `tenant_id` em queries e mutations
- âœ… Configurar contexto de tenant antes de operaÃ§Ãµes
- âœ… Adicionar `AIDEV-NOTE` em operaÃ§Ãµes crÃ­ticas
- âœ… Tratar e logar erros adequadamente
- âœ… Usar tipos TypeScript especÃ­ficos
- âœ… Seguir padrÃµes de nomenclatura

## ğŸ“š DocumentaÃ§Ã£o de ReferÃªncia

- `.cursor/BUGBOT.md` - Diretrizes de revisÃ£o
- `.cursor/CONTEXT.md` - Contexto completo do projeto
- `Contexto.md` - Especificidades tÃ©cnicas
- `SECURITY_GUIDELINES_AI_DEVELOPMENT.md` - Diretrizes de seguranÃ§a

## ğŸ¯ Objetivos

Ao gerar cÃ³digo, sempre:
1. Priorizar seguranÃ§a multi-tenant
2. Seguir padrÃµes estabelecidos
3. Manter consistÃªncia com cÃ³digo existente
4. Documentar operaÃ§Ãµes crÃ­ticas
5. Validar tipos TypeScript

