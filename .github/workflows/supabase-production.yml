name: Deploy Supabase - Production

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy automÃ¡tico para ProduÃ§Ã£o
    environment: production  # Requer aprovaÃ§Ã£o manual se configurado

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.PRODUCTION_PROJECT_ID }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para detectar mudanÃ§as

      - name: Configurar Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Autenticar no Supabase
        run: |
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Linkar ao projeto Production
        run: supabase link --project-ref $SUPABASE_PROJECT_ID

      - name: Detectar mudanÃ§as nas migrations (apenas mudanÃ§as de develop)
        id: detect-migrations
        run: |
          # Se for merge de develop para main, detectar apenas mudanÃ§as desde develop
          if [ "${{ github.event_name }}" == "push" ]; then
            # Tentar encontrar o commit anterior (antes do merge)
            PREV_COMMIT="${{ github.event.before }}"
            if [ -z "$PREV_COMMIT" ] || [ "$PREV_COMMIT" == "0000000000000000000000000000000000000000" ]; then
              # Se nÃ£o conseguir, verificar se hÃ¡ mudanÃ§as em migrations
              if git diff --name-only HEAD~1 HEAD | grep -q '^supabase/migrations/'; then
                echo "has_migrations=true" >> $GITHUB_OUTPUT
                echo "âœ… Novas migrations detectadas"
              else
                echo "has_migrations=false" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ Nenhuma migration nova"
              fi
            else
              if git diff --name-only $PREV_COMMIT ${{ github.sha }} | grep -q '^supabase/migrations/'; then
                echo "has_migrations=true" >> $GITHUB_OUTPUT
                echo "âœ… Novas migrations detectadas"
              else
                echo "has_migrations=false" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ Nenhuma migration nova"
              fi
            fi
          else
            # workflow_dispatch - aplicar todas as migrations pendentes
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… Deploy manual - aplicando todas as migrations"
          fi

      - name: Detectar mudanÃ§as nas Edge Functions (apenas mudanÃ§as de develop)
        id: detect-functions
        run: |
          # Se for merge de develop para main, detectar apenas mudanÃ§as desde develop
          if [ "${{ github.event_name }}" == "push" ]; then
            PREV_COMMIT="${{ github.event.before }}"
            if [ -z "$PREV_COMMIT" ] || [ "$PREV_COMMIT" == "0000000000000000000000000000000000000000" ]; then
              if git diff --name-only HEAD~1 HEAD | grep -q '^supabase/functions/'; then
                echo "has_functions=true" >> $GITHUB_OUTPUT
                echo "âœ… MudanÃ§as nas Edge Functions detectadas"
              else
                echo "has_functions=false" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ Nenhuma mudanÃ§a nas Edge Functions"
              fi
            else
              if git diff --name-only $PREV_COMMIT ${{ github.sha }} | grep -q '^supabase/functions/'; then
                echo "has_functions=true" >> $GITHUB_OUTPUT
                echo "âœ… MudanÃ§as nas Edge Functions detectadas"
              else
                echo "has_functions=false" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ Nenhuma mudanÃ§a nas Edge Functions"
              fi
            fi
          else
            # workflow_dispatch - deployar todas as functions
            echo "has_functions=true" >> $GITHUB_OUTPUT
            echo "âœ… Deploy manual - deployando todas as Edge Functions"
          fi

      - name: Reparar histÃ³rico de migrations (se necessÃ¡rio)
        if: steps.detect-migrations.outputs.has_migrations == 'true'
        continue-on-error: true
        run: |
          echo "ðŸ”§ Verificando histÃ³rico de migrations..."
          # Tenta fazer repair das migrations que estÃ£o no banco mas nÃ£o no repositÃ³rio
          # Isso marca migrations antigas como "reverted" para permitir aplicar novas
          # Lista completa de migrations do banco de produÃ§Ã£o que nÃ£o estÃ£o no repositÃ³rio
          # (extraÃ­da do erro do workflow)
          MIGRATIONS_TO_REVERT="20240101000000 20250127 20251125 20251126 20251127 20251128 20251212 20251213 20251220040909 20250517012408 20250517012422 20250517012535 20250517014048 20250517014223 20250517014341 20250517014352 20250517015203 20250517020108 20250517020120 20250517020138 20250517020340 20250517020351 20250517020410 20250517020940 20250517021030 20250517021226 20250517084720 20250517084733 20250517084747 20250517085000 20250517085256 20250517085610 20250517085917 20250517085929 20250517090450 20250517090636 20250518035257 20250518035348 20250518042637 20250518043343 20250518044213 20250518045912 20250518045932 20250518050729 20250518050800 20250518052059 20250518055903 20250621051819 20250621052306 20250621054043 20250703081644 20250704033241 20250707024333 20250707100552 20250710015824 20250710015909 20250710015931 20250710021254 20250710024224 20250710024436 20250711015919 20250715010104 20250715010142 20250715124608 20250715125417 20250715125728 20250716091059 20250718042341 20250721043654 20250722030741 20250722030804 20250722030825 20250722031010 20250722060614 20250725025613 20250806070916 20250806084711 20250806090141 20250807121647 20250807121739 20250807125402 20250807125954 20250808025432 20250808025552 20250808030319 20250808030533 20250808030829 20250808031101 20250808091204 20250808091742 20250808093141 20250808093557 20250811013139 20250811013425 20250811013804 20250811014811 20250811041848 20250811041923 20250811042732 20250811042822 20250811050202 20250811050349 20250812010110 20250812010132 20250812011031 20250812011117 20250812013736 20250812015526 20250812015555 20250812015619 20250812091743 20250812091835 20250812092722 20250812094424 20250812094657 20250812094715 20250818041851 20250818063411 20250818065714 20250818071034 20250818071322 20250818072114 20250818075256 20250818075640 20250818075759 20250818080530 20250818080652 20250818081122 20250818083322 20250818090747 20250818090924 20250818090958 20250818091040 20250818092105 20250818092148 20250818092229 20250818092310 20250818095357 20250820020135 20250820023757 20250820023923 20250820023955 20250820024149 20250820024239 20250820024249 20250820024302 20250821083808 20250821083929 20250821084021 20250821084045 20250821084206 20250821084245 20250821084327 20250821085548 20250821095330 20250821104623 20250821104727 20250821104808 20250822122952 20250822123030 20250822123107 20250901012419 20250901012442 20250901012459 20250901012531 20250901021344 20250901021743 20250901022341 20250901022407 20250901022720 20250901032148 20250901032240 20250901032306 20250901061932 20250901062055 20250901062447 20250901062523 20250901062614 20250901062746 20250901062815 20250901062829 20250901062859 20250901070121 20250901070152 20250901075105 20250901080333 20250901082011 20250901082026 20250901082048 20250901124051 20250901124150 20250902085225 20250902090657 20250902105634 20250902105838 20250902110307 20250902110421 20250902110453 20250902110515 20250902110542 20250902110639 20250902114945 20250902115725 20250902125028 20250903010027 20250903014029 20250903014208 20250903014345 20250903014424 20250903014457 20250903014530 20250903014626 20250903030059 20250903053524 20250905030722 20250905031848 20250905045923 20250905050119 20250905122615 20250905122635 20250905123035 20250907011300 20250907011347 20250907011746 20250907030510 20250907031032 20250907031851 20250907033830 20250907034409 20250907034611 20250907035300 20250907041458 20250907051959 20250907052116 20250907052146 20250907060202 20250907060225 20250907061547 20250907061620 20250907061708 20250907070819 20250907070846 20250907071008 20250907071039 20250907071523 20250907071616 20250907074011 20250907074333 20250908082627 20250909012020 20250909063354 20250909095551 20250909095608 20250910021449 20250910021511 20250910021529 20250910034055 20250910034556 20250910070240 20250910080543 20250910080558 20250910080615 20250910080639 20250911032026 20250911032927 20250911034012 20250911034450 20250911100030 20250911100447 20250911100543 20250911104051 20250911104631 20250911110254 20250911110313 20250911110353 20250911110526 20250911110551 20250911110641 20250911110703 20250911110724 20250911110744 20250911110818 20250911110847 20250911111052 20250911123603 20250911123802 20250911124130 20250912075108 20250912075644 20250915011611 20250915011620 20250915011646 20250915020127 20250915020710 20250915021119 20250915023502 20250915024857 20250915025021 20250915074440 20250915100850 20250915101116 20250915105333 20250915105453 20250915105515 20250915105541 20250915114832 20250916010033 20250916014209 20250916024246 20250916024313 20250916024446 20250916024516 20250916024731 20250916025546 20250916080316 20250916085129 20250916085754 20250916090345 20250916093350 20250916120332 20250916120442 20250916120527 20250916120618 20250916120725 20250916120825 20250916120950 20250916121121 20250916121226 20250916121310 20250916121511 20250916121736 20250916122129 20250916122307 20250916122710 20250916123024 20250916123113 20250916123412 20250916123655 20250916124854 20250916124923 20250917065915 20250917065942 20250917070014 20250917070141 20250917082356 20250917082419 20250917082430 20250917083353 20250917083433 20250917090016 20250917092724 20250918015355 20250918085401 20250918090522 20250918090822 20250919012455 20250920104129 20250920104240 20250920104250 20250920104259 20250920104307 20250920104320 20250920104351 20250920113414 20250922012740 20250922012750 20250922012807 20250922023618 20250922023745 20250922023755 20250922024220 20250922024246 20250922024257 20250922024458 20250922024645 20250922075346 20250922075433 20250922075631 20250923120127 20250923123141 20250923123240 20250923123306 20250923123321 20250923123350 20250923124824 20250925025401 20250925093703 20250926022302 20250926022416 20250926022522 20250926022539 20250926022648 20250926022752 20250926023612 20250926023642 20250926023701 20250926023727 20250926023811 20250926023822 20250926024011 20250926024752 20250926025158 20250926025819 20250926025932 20250926031952 20250926035820 20250926051840 20250926071642 20250926072542 20250926072555 20250928115730 20250929035814 20250930013240 20250930013524 20250930013555 20251001010024 20251001010441 20251001022050 20251001022114 20251001022544 20251001023238 20251001023545 20251001023703 20251001023743 20251001023822 20251001023952 20251001024035 20251001024110 20251001024142 20251001024249 20251001024550 20251001024724 20251001030052 20251001030108 20251001033917 20251001034949 20251001044614 20251001045327 20251001045354 20251001053514 20251001061228 20251001125801 20251002012949 20251002013021 20251002032447 20251002033613 20251002075834 20251002083001 20251002103259 20251003014321 20251003015800 20251004015646 20251004080446 20251007012840 20251007013014 20251007123921 20251008091240 20251009092034 20251009092138 20251009092158 20251009092240 20251009123612 20251010024243 20251010024331 20251010024437 20251010025357 20251010025515 20251010025552 20251010025632 20251010025833 20251010025911 20251010030406 20251010031557 20251010031638 20251010031704 20251010031732 20251010034140 20251010034314 20251010034353 20251010034415 20251010034447 20251010034503 20251010034518 20251010034538 20251010034731 20251010034807 20251010035203 20251010035314 20251010035400 20251010071309 20251010073241 20251011015920 20251011053134 20251011102323 20251011102409 20251011111226 20251012014543 20251012102119 20251012102247 20251012104102 20251012104159 20251012105707 20251012105821 20251012112429 20251012112455 20251012112615 20251012125927 20251013010236 20251013012510 20251013012522 20251013012537 20251013012604 20251013013644 20251013014433 20251013014538 20251013014613 20251013014757 20251013020022 20251013020127 20251013021027 20251013021128 20251013021248 20251013022209 20251013022338 20251013023439 20251013024645 20251013024732 20251013030839 20251013030930 20251013033357 20251013035906 20251013071410 20251013080202 20251013082632 20251013082714 20251013093147 20251013100029 20251013100112 20251013100209 20251013100229 20251013102454 20251013120856 20251013121026 20251013122142 20251013123925 20251014101449 20251014192931 20251014192950 20251014200723 20251014200739 20251014201524 20251014201536 20251014201606 20251014202302 20251014202317 20251014203934 20251014204004 20251014204037 20251014205040 20251014205243 20251014205340 20251014205436 20251014210604 20251014215823 20251014215921 20251014220522 20251015031449 20251015141421 20251015154127 20251015154554 20251015154848 20251015161728 20251015161820 20251015161954 20251015162120 20251015162202 20251015162248 20251015162307 20251015162347 20251015163216 20251015163305 20251015163911 20251015164404 20251015171238 20251015171421 20251015171554 20251015171716 20251015181923 20251015182006 20251015182052 20251015182146 20251015184754 20251015185044 20251015185914 20251015190514 20251015190745 20251015191725 20251015192757 20251015192906 20251016032855 20251016040541 20251016155627 20251016155642 20251016192031 20251016194248 20251016201951 20251016213443 20251016213543 20251017160907 20251017203732 20251017203812 20251017234335 20251017234805 20251018205948 20251018210534 20251018224105 20251019021512 20251019063430 20251020154216 20251020160233 20251021140651 20251021215005 20251021215127 20251021215507 20251021215537 20251021215624 20251021220055 20251022190225 20251022192709 20251022204857 20251022204914 20251022204930 20251022204948 20251022205012 20251022205657 20251023124020 20251023124412 20251023124456 20251023124603 20251023130042 20251023130339 20251023210228 20251024140533 20251024161738 20251024211601 20251103200531 20251104153214 20251104161413 20251104163650 20251104164205 20251106225959 20251106235551 20251107000505 20251107001028 20251109142654 20251110013255 20251110013350 20251110021345 20251110023145 20251110023215 20251110023723 20251110024351 20251110024405 20251110032537 20251110032902 20251110154034 20251111041352 20251111141419 20251111154430 20251111154942 20251112203520 20251113002616 20251113022157 20251113022225 20251113022252 20251113142620 20251113152733 20251113210428 20251113211508 20251113212234 20251114161106 20251114162449 20251114163654 20251114205109 20251114205515 20251114205543 20251114222148 20251115015836 20251115031747 20251115031958 20251115032010 20251115032032 20251115032156 20251115032212 20251115035634 20251115035709 20251115040103 20251115040111 20251116025859 20251116025922 20251116025929 20251116175353 20251116182250 20251116182300 20251116192251 20251117142415 20251117145552 20251118144909 20251118144955 20251118145032 20251118154220 20251118154535 20251119185909 20251119192544 20251119205543 20251119220826 20251119222546 20251119222742 20251125193951 20251125194000 20251125194008 20251125194252 20251125195948 20251125200003 20251125200017 20251125200645 20251125202229 20251125202621 20251125203257 20251125215100 20251125215117 20251125215132 20251125215353 20251125215532 20251126025836 20251126030334 20251126202618 20251126203005 20251126215837 20251205211208 20251206164850 20251206164929 20251206203909 20251208193049 20251208195713 20251208195940 20251208200823 20251209135402 20251209135421 20251209135445 20251209135538 20251209135633 20251209135654 20251209135750 20251209135825 20251209141303 20251209141420 20251209141726 20251209141934 20251211013121 20251211013612 20251211021828 20251212131707 20251212141253 20251212141349 20251212170149 20251212182414 20251213121431 20251213123806 20251213123855 20251215161756 20251216235530 20251217145742 20251217150321 20251217153953"
          
          echo "ðŸ“‹ Reparando histÃ³rico de migrations (pode levar alguns segundos)..."
          if supabase migration repair --status reverted $MIGRATIONS_TO_REVERT 2>&1; then
            echo "âœ… HistÃ³rico de migrations reparado (migrations antigas marcadas como reverted)"
          else
            echo "â„¹ï¸ Repair nÃ£o necessÃ¡rio ou migrations jÃ¡ foram reparadas"
          fi

      - name: Marcar migrations jÃ¡ aplicadas no histÃ³rico
        if: steps.detect-migrations.outputs.has_migrations == 'true'
        continue-on-error: true
        run: |
          echo "ðŸ” Verificando migrations que jÃ¡ foram aplicadas..."
          # Marca migrations grandes que provavelmente jÃ¡ foram aplicadas como aplicadas no histÃ³rico
          # Isso evita tentar aplicÃ¡-las novamente
          supabase migration repair --status applied 20251218191500 20251219185127 2>/dev/null || echo "â„¹ï¸ Migrations jÃ¡ marcadas ou nÃ£o encontradas"

      - name: Aplicar migraÃ§Ãµes (apenas mudanÃ§as de develop)
        if: steps.detect-migrations.outputs.has_migrations == 'true'
        run: |
          echo "ðŸš€ Aplicando migrations na produÃ§Ã£o..."
          echo "âš ï¸  ATENÃ‡ÃƒO: Isso irÃ¡ modificar o banco de dados de produÃ§Ã£o!"
          # Usa --yes para aceitar automaticamente
          # Usa --include-all para incluir migrations nÃ£o rastreadas
          # O repair anterior jÃ¡ marcou migrations antigas como reverted
          # As migrations grandes jÃ¡ foram marcadas como aplicadas no passo anterior
          supabase db push --include-all --yes

      - name: Deploy Edge Functions (apenas mudanÃ§as de develop)
        if: steps.detect-functions.outputs.has_functions == 'true'
        run: |
          echo "ðŸš€ Fazendo deploy das Edge Functions na produÃ§Ã£o..."
          supabase functions deploy

      - name: Deploy todas as Edge Functions (se migrations foram aplicadas)
        if: steps.detect-functions.outputs.has_functions == 'false' && steps.detect-migrations.outputs.has_migrations == 'true'
        run: |
          echo "ðŸš€ Fazendo deploy de todas as Edge Functions (apÃ³s migrations)..."
          supabase functions deploy

      - name: Resumo do deploy
        run: |
          echo "## ðŸš€ Deploy ProduÃ§Ã£o ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Projeto:** ProduÃ§Ã£o (main)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch Git:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Autor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detect-migrations.outputs.has_migrations }}" == "true" ]; then
            echo "âœ… Migrations aplicadas" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Nenhuma migration nova para aplicar" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.detect-functions.outputs.has_functions }}" == "true" ]; then
            echo "âœ… Edge Functions deployadas" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Nenhuma mudanÃ§a nas Edge Functions" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** https://supabase.com/dashboard/project/${{ secrets.PRODUCTION_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
