name: Deploy Supabase - Development

on:
  push:
    branches:
      - develop
    paths:
      - 'supabase/**'
  workflow_dispatch:
    inputs:
      force_apply_all:
        description: 'ForÃ§ar aplicar todas as migrations pendentes (ignora detecÃ§Ã£o de mudanÃ§as)'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy automÃ¡tico para Development
    environment: Preview  # Nome do environment no GitHub (pode ser "Preview" ou "development")

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.DEVELOPMENT_PROJECT_ID }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para detectar mudanÃ§as

      - name: Configurar Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Autenticar no Supabase
        run: |
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Linkar ao projeto Development
        run: supabase link --project-ref $SUPABASE_PROJECT_ID

      - name: Detectar mudanÃ§as nas migrations
        id: detect-migrations
        run: |
          # Se for workflow_dispatch com force_apply_all, aplicar todas as migrations
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_apply_all }}" == "true" ]; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… ExecuÃ§Ã£o manual: aplicando todas as migrations pendentes"
          # Se for workflow_dispatch sem force, verificar se hÃ¡ migrations pendentes
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Verificar se hÃ¡ migrations no diretÃ³rio que nÃ£o foram aplicadas
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… ExecuÃ§Ã£o manual: verificando migrations pendentes"
          # Se for push, detectar mudanÃ§as entre commits
          elif [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ] && [ -n "${{ github.event.before }}" ]; then
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^supabase/migrations/'; then
              echo "has_migrations=true" >> $GITHUB_OUTPUT
              echo "âœ… Novas migrations detectadas"
            else
              echo "has_migrations=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Nenhuma migration nova"
            fi
          else
            # Fallback: aplicar todas as migrations
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… Aplicando todas as migrations pendentes"
          fi

      - name: Detectar mudanÃ§as nas Edge Functions
        id: detect-functions
        run: |
          # Se for workflow_dispatch, sempre verificar functions
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "has_functions=true" >> $GITHUB_OUTPUT
            echo "âœ… ExecuÃ§Ã£o manual: verificando Edge Functions"
          # Se for push, detectar mudanÃ§as entre commits
          elif [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ] && [ -n "${{ github.event.before }}" ]; then
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^supabase/functions/'; then
              echo "has_functions=true" >> $GITHUB_OUTPUT
              echo "âœ… MudanÃ§as nas Edge Functions detectadas"
            else
              echo "has_functions=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Nenhuma mudanÃ§a nas Edge Functions"
            fi
          else
            echo "has_functions=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhuma mudanÃ§a nas Edge Functions"
          fi

      - name: Reparar histÃ³rico de migrations (se necessÃ¡rio)
        if: steps.detect-migrations.outputs.has_migrations == 'true'
        continue-on-error: true
        run: |
          echo "ðŸ”§ Verificando histÃ³rico de migrations..."
          # Tenta fazer repair das migrations que estÃ£o no banco mas nÃ£o no repositÃ³rio
          # Isso marca migrations antigas como "reverted" para permitir aplicar novas
          # As migrations listadas sÃ£o as que o erro mencionou como faltando no repositÃ³rio
          if supabase migration repair --status reverted 20240101000000 20250127 20251125 20251126 20251127 20251128 20251212 20251213 20251220040909 2>&1; then
            echo "âœ… HistÃ³rico de migrations reparado"
          else
            echo "â„¹ï¸ Repair nÃ£o necessÃ¡rio ou migrations jÃ¡ foram reparadas"
          fi

      - name: Aplicar migraÃ§Ãµes (se houver mudanÃ§as)
        if: steps.detect-migrations.outputs.has_migrations == 'true'
        run: |
          echo "ðŸš€ Aplicando migrations..."
          supabase db push --include-all

      - name: Deploy Edge Functions (se houver mudanÃ§as)
        if: steps.detect-functions.outputs.has_functions == 'true'
        run: |
          echo "ðŸš€ Fazendo deploy das Edge Functions..."
          supabase functions deploy

      - name: Deploy todas as Edge Functions (se nÃ£o detectar mudanÃ§as especÃ­ficas)
        if: steps.detect-functions.outputs.has_functions == 'false' && steps.detect-migrations.outputs.has_migrations == 'true'
        run: |
          echo "ðŸš€ Fazendo deploy de todas as Edge Functions (apÃ³s migrations)..."
          supabase functions deploy

      - name: Resumo do deploy
        run: |
          echo "## ðŸš€ Deploy Development ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Projeto:** Development (develop)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch Git:** develop" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Autor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detect-migrations.outputs.has_migrations }}" == "true" ]; then
            echo "âœ… Migrations aplicadas" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.detect-functions.outputs.has_functions }}" == "true" ]; then
            echo "âœ… Edge Functions deployadas" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** https://supabase.com/dashboard/project/${{ secrets.DEVELOPMENT_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY

