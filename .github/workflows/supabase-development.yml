name: Deploy Supabase - Development

on:
  push:
    branches:
      - develop
    paths:
      - 'supabase/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy automÃ¡tico para Development
    environment: Preview  # Nome do environment no GitHub (pode ser "Preview" ou "development")

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.DEVELOPMENT_PROJECT_ID }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para detectar mudanÃ§as

      - name: Configurar Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Autenticar no Supabase
        run: |
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Linkar ao projeto Development
        run: supabase link --project-ref $SUPABASE_PROJECT_ID

      - name: Detectar mudanÃ§as nas migrations
        id: detect-migrations
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^supabase/migrations/'; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… Novas migrations detectadas"
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhuma migration nova"
          fi

      - name: Detectar mudanÃ§as nas Edge Functions
        id: detect-functions
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^supabase/functions/'; then
            echo "has_functions=true" >> $GITHUB_OUTPUT
            echo "âœ… MudanÃ§as nas Edge Functions detectadas"
          else
            echo "has_functions=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nenhuma mudanÃ§a nas Edge Functions"
          fi

      - name: Aplicar migraÃ§Ãµes (se houver mudanÃ§as)
        if: steps.detect-migrations.outputs.has_migrations == 'true'
        run: |
          echo "ðŸš€ Aplicando migrations..."
          supabase db push --project-ref $SUPABASE_PROJECT_ID

      - name: Deploy Edge Functions (se houver mudanÃ§as)
        if: steps.detect-functions.outputs.has_functions == 'true'
        run: |
          echo "ðŸš€ Fazendo deploy das Edge Functions..."
          supabase functions deploy --project-ref $SUPABASE_PROJECT_ID

      - name: Deploy todas as Edge Functions (se nÃ£o detectar mudanÃ§as especÃ­ficas)
        if: steps.detect-functions.outputs.has_functions == 'false' && steps.detect-migrations.outputs.has_migrations == 'true'
        run: |
          echo "ðŸš€ Fazendo deploy de todas as Edge Functions (apÃ³s migrations)..."
          supabase functions deploy --project-ref $SUPABASE_PROJECT_ID

      - name: Resumo do deploy
        run: |
          echo "## ðŸš€ Deploy Development ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Projeto:** Development (develop)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch Git:** develop" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Autor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detect-migrations.outputs.has_migrations }}" == "true" ]; then
            echo "âœ… Migrations aplicadas" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.detect-functions.outputs.has_functions }}" == "true" ]; then
            echo "âœ… Edge Functions deployadas" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** https://supabase.com/dashboard/project/${{ secrets.DEVELOPMENT_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY

