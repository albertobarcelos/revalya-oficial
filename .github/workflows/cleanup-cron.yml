name: Daily Token Cleanup

on:
  schedule:
    # Executa diariamente Ã s 02:00 UTC (23:00 BRT)
    - cron: '0 2 * * *'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  cleanup-production:
    runs-on: ubuntu-latest
    name: Cleanup Production
    environment: production
    
    steps:
      - name: Validar Secrets
        run: |
          echo "Verificando secrets..."
          echo "PRODUCTION_SUPABASE_URL estÃ¡ configurado: $([ -n "${{ secrets.PRODUCTION_SUPABASE_URL }}" ] && echo 'SIM' || echo 'NÃƒO')"
          echo "CRON_SECRET estÃ¡ configurado: $([ -n "${{ secrets.CRON_SECRET }}" ] && echo 'SIM' || echo 'NÃƒO')"
          
          if [ -z "${{ secrets.PRODUCTION_SUPABASE_URL }}" ]; then
            echo "âŒ Erro: PRODUCTION_SUPABASE_URL nÃ£o estÃ¡ configurado"
            echo "Configure o secret em: Settings â†’ Secrets and variables â†’ Actions"
            echo "Ou configure no Environment 'production': Settings â†’ Environments â†’ production â†’ Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ Erro: CRON_SECRET nÃ£o estÃ¡ configurado"
            echo "Configure o secret em: Settings â†’ Secrets and variables â†’ Actions"
            echo "Ou configure no Environment 'production': Settings â†’ Environments â†’ production â†’ Secrets"
            exit 1
          fi
          echo "âœ… Secrets validados"
      
      - name: Execute Cleanup - Production
        id: cleanup
        run: |
          set -e
          echo "ðŸš€ Executando cleanup na produÃ§Ã£o..."
          
          SUPABASE_URL="${{ secrets.PRODUCTION_SUPABASE_URL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          if [ -z "$SUPABASE_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "âŒ Erro: Secrets nÃ£o configurados"
            exit 1
          fi
          
          FULL_URL="${SUPABASE_URL}/functions/v1/cron-cleanup-scheduler"
          echo "URL: $FULL_URL"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${CRON_SECRET}" \
            "${FULL_URL}" || echo -e "\n000")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Cleanup executado com sucesso"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Erro no cleanup: HTTP $HTTP_CODE"
            echo "$BODY" >&2
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        
      - name: Log Execution
        if: always()
        run: |
          echo "## ðŸ§¹ Cleanup Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Executado em:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.cleanup.outputs.success }}" >> $GITHUB_STEP_SUMMARY

  cleanup-development:
    runs-on: ubuntu-latest
    name: Cleanup Development
    environment: Preview
    
    steps:
      - name: Validar Secrets
        run: |
          echo "Verificando secrets..."
          echo "DEVELOPMENT_SUPABASE_URL estÃ¡ configurado: $([ -n "${{ secrets.DEVELOPMENT_SUPABASE_URL }}" ] && echo 'SIM' || echo 'NÃƒO')"
          echo "CRON_SECRET_DEV estÃ¡ configurado: $([ -n "${{ secrets.CRON_SECRET_DEV }}" ] && echo 'SIM' || echo 'NÃƒO')"
          
          if [ -z "${{ secrets.DEVELOPMENT_SUPABASE_URL }}" ]; then
            echo "âŒ Erro: DEVELOPMENT_SUPABASE_URL nÃ£o estÃ¡ configurado"
            echo "Configure o secret em: Settings â†’ Secrets and variables â†’ Actions"
            echo "Ou configure no Environment 'Preview': Settings â†’ Environments â†’ Preview â†’ Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET_DEV }}" ]; then
            echo "âŒ Erro: CRON_SECRET_DEV nÃ£o estÃ¡ configurado"
            echo "Configure o secret em: Settings â†’ Secrets and variables â†’ Actions"
            echo "Ou configure no Environment 'Preview': Settings â†’ Environments â†’ Preview â†’ Secrets"
            exit 1
          fi
          echo "âœ… Secrets validados"
      
      - name: Execute Cleanup - Development
        id: cleanup
        run: |
          set -e
          echo "ðŸš€ Executando cleanup na development..."
          
          SUPABASE_URL="${{ secrets.DEVELOPMENT_SUPABASE_URL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET_DEV }}"
          
          if [ -z "$SUPABASE_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "âŒ Erro: Secrets nÃ£o configurados"
            exit 1
          fi
          
          FULL_URL="${SUPABASE_URL}/functions/v1/cron-cleanup-scheduler"
          echo "URL: $FULL_URL"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${CRON_SECRET}" \
            "${FULL_URL}" || echo -e "\n000")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Cleanup executado com sucesso"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Erro no cleanup: HTTP $HTTP_CODE"
            echo "$BODY" >&2
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Log Execution
        if: always()
        run: |
          echo "## ðŸ§¹ Cleanup Development" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Executado em:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.cleanup.outputs.success }}" >> $GITHUB_STEP_SUMMARY
