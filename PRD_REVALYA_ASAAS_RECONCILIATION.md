# PRD - Sistema de Reconcilia√ß√£o Financeira ASAAS
## Revalya Platform

---

## üìã Informa√ß√µes do Documento

| Campo | Valor |
|-------|-------|
| **Produto** | Revalya - Sistema de Reconcilia√ß√£o Financeira |
| **Vers√£o** | 1.0 |
| **Data** | Janeiro 2025 |
| **Autor** | Barcelitos AI |
| **Status** | Ativo |
| **Projeto Supabase** | wyehpiutzvwplllumgdk |
| **Regi√£o** | sa-east-1 |

---

## üéØ Vis√£o Geral do Produto

### Prop√≥sito Central
O Sistema de Reconcilia√ß√£o Financeira ASAAS √© um m√≥dulo cr√≠tico da plataforma Revalya que automatiza a sincroniza√ß√£o, importa√ß√£o e reconcilia√ß√£o de dados financeiros entre o sistema interno e a API do ASAAS (gateway de pagamentos brasileiro).

### Problema Resolvido
- **Reconcilia√ß√£o Manual**: Elimina√ß√£o do processo manual de confer√™ncia de pagamentos
- **Diverg√™ncias Financeiras**: Detec√ß√£o autom√°tica de inconsist√™ncias entre sistemas
- **Visibilidade Limitada**: Centraliza√ß√£o de dados financeiros em tempo real
- **Auditoria Complexa**: Rastreabilidade completa de todas as transa√ß√µes
- **Multi-tenancy**: Isolamento seguro de dados por tenant

---

## üèóÔ∏è Arquitetura do Sistema

### Stack Tecnol√≥gico
- **Frontend**: React 18.2.0 + TypeScript 5.3.3 + Vite
- **UI Framework**: Shadcn/UI + Tailwind CSS 3.4.1 + Radix UI
- **Backend**: Supabase (PostgreSQL + Edge Functions)
- **Autentica√ß√£o**: Supabase Auth com RLS
- **State Management**: TanStack Query 5.17.9 + Context API
- **Anima√ß√µes**: Framer Motion 11.0.3

### Componentes Principais

#### 1. **Frontend (React)**
```typescript
// Componentes principais identificados via MCP
src/components/
‚îú‚îÄ‚îÄ billing/
‚îÇ   ‚îú‚îÄ‚îÄ ChargeIntegrationManager.tsx    # Interface principal de reconcilia√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ parts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ReconciliationTable.tsx     # Tabela de dados staging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ActionButtons.tsx           # A√ß√µes de reconcilia√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ StatusIndicators.tsx        # Indicadores visuais
‚îÇ   ‚îî‚îÄ‚îÄ schema/
‚îÇ       ‚îî‚îÄ‚îÄ reconciliation.ts           # Schemas Zod
‚îî‚îÄ‚îÄ shared/
    ‚îú‚îÄ‚îÄ LoadingStates.tsx               # Estados de carregamento
    ‚îî‚îÄ‚îÄ ErrorBoundary.tsx               # Tratamento de erros
```

#### 2. **Backend (Supabase Edge Functions)**
```typescript
// Edge Functions identificadas via MCP
supabase/functions/
‚îú‚îÄ‚îÄ asaas-webhook-charges/              # Webhook em tempo real
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                        # Processamento de webhooks ASAAS
‚îú‚îÄ‚îÄ asaas-import-charges/               # Importa√ß√£o batch
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                        # Importa√ß√£o hist√≥rica de cobran√ßas
‚îú‚îÄ‚îÄ asaas-proxy/                        # Proxy seguro para API
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                        # Intermedia√ß√£o de requisi√ß√µes
‚îî‚îÄ‚îÄ _shared/
    ‚îú‚îÄ‚îÄ cors.ts                         # Configura√ß√µes CORS
    ‚îî‚îÄ‚îÄ validation.ts                   # Valida√ß√µes comuns
```

#### 3. **Camada de Servi√ßos**
```typescript
// Servi√ßos identificados via an√°lise de c√≥digo
src/services/
‚îú‚îÄ‚îÄ chargeIntegrationService.ts         # Orquestra√ß√£o principal
‚îú‚îÄ‚îÄ gatewayService.ts                   # Interface com gateways
‚îú‚îÄ‚îÄ billingAutomationService.ts         # Automa√ß√£o de cobran√ßa
‚îî‚îÄ‚îÄ webhookSyncService.ts               # Sincroniza√ß√£o de webhooks
```

#### 4. **Hooks Customizados**
```typescript
// Hooks identificados via an√°lise de c√≥digo
src/hooks/
‚îú‚îÄ‚îÄ useChargeIntegration.ts             # Hook principal de integra√ß√£o
‚îú‚îÄ‚îÄ useChargeActions.ts                 # A√ß√µes de cobran√ßa
‚îú‚îÄ‚îÄ useBillingAutomation.ts             # Automa√ß√£o de billing
‚îî‚îÄ‚îÄ templates/
    ‚îî‚îÄ‚îÄ useTenantAccessGuard.ts         # Seguran√ßa multi-tenant
```

---

## üóÑÔ∏è Estrutura de Dados (An√°lise MCP)

### Tabela Central: `conciliation_staging`
```sql
-- AIDEV-NOTE: Tabela identificada via MCP Supabase
CREATE TABLE conciliation_staging (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  
  -- Identifica√ß√£o Externa
  origem TEXT NOT NULL CHECK (origem IN ('ASAAS', 'CORA', 'MANUAL')),
  id_externo TEXT NOT NULL,
  external_reference TEXT,
  
  -- Dados Financeiros
  valor_cobranca DECIMAL(15,2) NOT NULL,
  valor_pago DECIMAL(15,2) DEFAULT 0,
  valor_liquido DECIMAL(15,2),
  valor_juros DECIMAL(15,2),
  valor_multa DECIMAL(15,2),
  valor_desconto DECIMAL(15,2),
  
  -- Status e Controle
  status_externo TEXT NOT NULL,
  status_conciliacao TEXT DEFAULT 'PENDENTE' 
    CHECK (status_conciliacao IN ('PENDENTE', 'CONCILIADO', 'DIVERGENTE')),
  
  -- Datas
  data_vencimento DATE,
  data_pagamento DATE,
  
  -- Dados do Cliente (ASAAS)
  asaas_customer_id TEXT,
  customer_name TEXT,
  customer_email TEXT,
  customer_document TEXT,
  customer_phone TEXT,
  customer_mobile_phone TEXT,
  customer_company TEXT,
  customer_address TEXT,
  customer_address_number TEXT,
  customer_complement TEXT,
  customer_postal_code TEXT,
  customer_province TEXT,
  customer_city TEXT,
  customer_cityName TEXT,
  customer_state TEXT,
  customer_country TEXT DEFAULT 'Brasil',
  
  -- Metadados
  observacao TEXT,
  raw_data JSONB,
  dados_webhook JSONB,
  processado_em TIMESTAMP WITH TIME ZONE,
  
  -- Auditoria
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- Constraints
  UNIQUE(tenant_id, id_externo, origem)
);
```

### Tabelas Relacionadas (Identificadas via MCP)
```sql
-- Integra√ß√µes por Tenant
tenant_integrations (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id),
  integration_type TEXT CHECK (integration_type IN ('asaas', 'cora')),
  config JSONB NOT NULL,
  webhook_token TEXT,
  is_active BOOLEAN DEFAULT true
);

-- Cobran√ßas do Sistema
charges (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id),
  external_id TEXT,
  status TEXT,
  amount DECIMAL(15,2),
  due_date DATE,
  -- ... outros campos
);

-- Reconcilia√ß√µes Processadas
payment_reconciliations (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id),
  charge_id UUID REFERENCES charges(id),
  staging_id UUID REFERENCES conciliation_staging(id),
  reconciliation_type TEXT,
  reconciled_at TIMESTAMP WITH TIME ZONE
);
```

---

## üîÑ Fluxos de Processo

### 1. **Fluxo de Importa√ß√£o Autom√°tica**
```mermaid
graph TD
    A[Scheduler/Manual Trigger] --> B[asaas-import-charges]
    B --> C[Buscar Config Tenant]
    C --> D[Validar API Key ASAAS]
    D --> E[Fetch Payments API]
    E --> F[Processar Batch]
    F --> G[Enriquecer com Customer Data]
    G --> H[Insert/Update Staging]
    H --> I[Retornar Summary]
```

### 2. **Fluxo de Webhook em Tempo Real**
```mermaid
graph TD
    A[ASAAS Webhook] --> B[asaas-webhook-charges/{tenant_id}]
    B --> C[Validar Tenant Context]
    C --> D[Verificar Webhook Token]
    D --> E[Processar Payload]
    E --> F[Mapear Status]
    F --> G[Upsert Staging]
    G --> H[Resposta Success]
```

### 3. **Fluxo de Reconcilia√ß√£o Visual**
```mermaid
graph TD
    A[ChargeIntegrationManager] --> B[Carregar Staging Data]
    B --> C[Exibir Tabela Reconcilia√ß√£o]
    C --> D[Usu√°rio Seleciona A√ß√£o]
    D --> E{Tipo de A√ß√£o}
    E -->|Conciliar| F[Marcar como Conciliado]
    E -->|Criar Cobran√ßa| G[Criar Nova Charge]
    E -->|Ignorar| H[Marcar como Ignorado]
    F --> I[Atualizar Status]
    G --> I
    H --> I
    I --> J[Refresh UI]
```

---

## üõ°Ô∏è Seguran√ßa Multi-Tenant

### 5 Camadas de Seguran√ßa (Implementadas)

#### 1. **Valida√ß√£o de Acesso**
```typescript
// AIDEV-NOTE: Hook de seguran√ßa obrigat√≥rio
export function useTenantAccessGuard() {
  const { hasAccess, currentTenant } = useAuth();
  
  if (!hasAccess || !currentTenant) {
    throw new Error('Acesso negado');
  }
  
  return { hasAccess, currentTenant };
}
```

#### 2. **Consultas Seguras**
```typescript
// AIDEV-NOTE: Padr√£o de query segura
export function useSecureTenantQuery() {
  const { currentTenant } = useTenantAccessGuard();
  
  return useQuery({
    queryKey: ['reconciliation', currentTenant.id],
    queryFn: async () => {
      // Configurar contexto obrigat√≥rio
      await supabase.rpc('set_tenant_context_simple', {
        p_tenant_id: currentTenant.id
      });
      
      // Query com RLS autom√°tico
      const { data, error } = await supabase
        .from('conciliation_staging')
        .select('*');
        
      if (error) throw error;
      return data;
    }
  });
}
```

#### 3. **RLS Policies (Row Level Security)**
```sql
-- AIDEV-NOTE: Pol√≠ticas RLS identificadas via MCP
CREATE POLICY "tenant_isolation_conciliation_staging" 
ON conciliation_staging 
FOR ALL 
USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY "tenant_isolation_tenant_integrations" 
ON tenant_integrations 
FOR ALL 
USING (tenant_id = current_setting('app.current_tenant_id')::uuid);
```

#### 4. **Valida√ß√£o Dupla**
- Client-side: Hooks de valida√ß√£o
- Server-side: RLS + Edge Functions

#### 5. **Auditoria Completa**
```sql
-- AIDEV-NOTE: Campos de auditoria obrigat√≥rios
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
processado_em TIMESTAMP WITH TIME ZONE,
raw_data JSONB,  -- Dados originais preservados
dados_webhook JSONB  -- Payload completo do webhook
```

---

## üé® Interface do Usu√°rio

### Componente Principal: ChargeIntegrationManager
```typescript
// AIDEV-NOTE: Estrutura do componente principal
interface ChargeIntegrationManagerProps {
  tenantId: string;
  integrationId?: string;
}

export function ChargeIntegrationManager({ tenantId }: ChargeIntegrationManagerProps) {
  // 1. Hooks de seguran√ßa
  const { hasAccess } = useTenantAccessGuard();
  
  // 2. Estado e dados
  const { data: stagingData, isLoading } = useSecureTenantQuery();
  
  // 3. A√ß√µes dispon√≠veis
  const { reconcileCharge, createCharge, ignoreCharge } = useChargeActions();
  
  // 4. Render com anima√ß√µes
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="space-y-6"
    >
      <Card className="rounded-2xl shadow-lg">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <CreditCard className="h-5 w-5" />
            Reconcilia√ß√£o Financeira ASAAS
          </CardTitle>
        </CardHeader>
        <CardContent>
          <ReconciliationTable 
            data={stagingData}
            onReconcile={reconcileCharge}
            onCreateCharge={createCharge}
            onIgnore={ignoreCharge}
          />
        </CardContent>
      </Card>
    </motion.div>
  );
}
```

### Funcionalidades da Interface

#### 1. **Tabela de Reconcilia√ß√£o**
- ‚úÖ Listagem paginada de dados staging
- ‚úÖ Filtros por status, per√≠odo, valor
- ‚úÖ Ordena√ß√£o por colunas
- ‚úÖ Sele√ß√£o m√∫ltipla para a√ß√µes em lote

#### 2. **A√ß√µes Dispon√≠veis**
- üîÑ **Conciliar**: Marcar como reconciliado
- ‚ûï **Criar Cobran√ßa**: Gerar nova charge no sistema
- ‚ùå **Ignorar**: Marcar como ignorado
- üìä **Visualizar Detalhes**: Modal com dados completos
- üîÑ **Reprocessar**: Tentar reconcilia√ß√£o autom√°tica

#### 3. **Indicadores Visuais**
- üü¢ **Verde**: Conciliado
- üü° **Amarelo**: Pendente
- üî¥ **Vermelho**: Divergente
- ‚ö™ **Cinza**: Ignorado

#### 4. **M√©tricas em Tempo Real**
```typescript
interface ReconciliationMetrics {
  totalPendente: number;
  totalConciliado: number;
  totalDivergente: number;
  valorTotalPendente: number;
  valorTotalConciliado: number;
  percentualConciliacao: number;
}
```

---

## üîß Configura√ß√µes e Integra√ß√µes

### Configura√ß√£o ASAAS por Tenant
```typescript
interface AsaasConfig {
  api_key: string;           // Chave da API ASAAS
  api_url: string;           // URL base da API (sandbox/prod)
  webhook_token?: string;    // Token para valida√ß√£o de webhooks
  auto_import: boolean;      // Importa√ß√£o autom√°tica ativa
  import_interval: number;   // Intervalo em horas
  reconcile_auto: boolean;   // Reconcilia√ß√£o autom√°tica
}
```

### Endpoints das Edge Functions
```typescript
// AIDEV-NOTE: URLs identificadas via MCP
const EDGE_FUNCTIONS = {
  webhook: `/functions/v1/asaas-webhook-charges/{tenant_id}`,
  import: `/functions/v1/asaas-import-charges`,
  proxy: `/functions/v1/asaas-proxy/{tenant_id}`,
  customer: `/functions/v1/fetch-asaas-customer/{tenant_id}`
};
```

---

## üìä M√©tricas e Monitoramento

### KPIs Principais
1. **Taxa de Reconcilia√ß√£o**: % de registros conciliados automaticamente
2. **Tempo M√©dio de Processamento**: Lat√™ncia de webhooks e imports
3. **Volume de Transa√ß√µes**: Quantidade por per√≠odo
4. **Taxa de Erro**: % de falhas na sincroniza√ß√£o
5. **Diverg√™ncias Detectadas**: Inconsist√™ncias entre sistemas

### Alertas Configurados
- üö® **Webhook Offline**: Mais de 5 min sem receber webhooks
- ‚ö†Ô∏è **Diverg√™ncia Alta**: Mais de 10% de registros divergentes
- üî¥ **Erro de API**: Falhas consecutivas na API ASAAS
- üìà **Volume An√¥malo**: Picos de transa√ß√µes fora do padr√£o

---

## üîÑ Automa√ß√µes Implementadas

### 1. **Importa√ß√£o Autom√°tica**
- ‚è∞ **Agendamento**: Execu√ß√£o a cada 4 horas
- üìÖ **Per√≠odo**: √öltimas 24 horas
- üîÑ **Incremental**: Apenas novos registros
- üõ°Ô∏è **Retry Logic**: 3 tentativas com backoff

### 2. **Reconcilia√ß√£o Inteligente**
- üéØ **Match por ID**: external_reference + valor
- üìä **Score de Similaridade**: Algoritmo de matching
- ü§ñ **Auto-approve**: Matches com 100% de confian√ßa
- üëÅÔ∏è **Review Manual**: Matches com score < 95%

### 3. **Notifica√ß√µes**
- üìß **Email**: Resumo di√°rio de reconcilia√ß√µes
- üîî **In-app**: Alertas de diverg√™ncias
- üì± **Webhook**: Integra√ß√£o com sistemas externos
- üìä **Dashboard**: M√©tricas em tempo real

---

## üöÄ Roadmap e Melhorias

### Fase 1 - Atual (Implementado)
- ‚úÖ Webhook ASAAS em tempo real
- ‚úÖ Importa√ß√£o batch hist√≥rica
- ‚úÖ Interface de reconcilia√ß√£o visual
- ‚úÖ Seguran√ßa multi-tenant
- ‚úÖ Auditoria completa

### Fase 2 - Pr√≥ximas Funcionalidades
- üîÑ **Reconcilia√ß√£o por ML**: Machine Learning para matching
- üìä **Analytics Avan√ßado**: Dashboards executivos
- üîó **M√∫ltiplos Gateways**: Suporte a outros provedores
- üì± **App Mobile**: Interface mobile nativa
- ü§ñ **Chatbot**: Assistente para reconcilia√ß√£o

### Fase 3 - Futuro
- üåê **API P√∫blica**: Endpoints para terceiros
- üîÑ **Sync Bidirecional**: Atualiza√ß√£o ASAAS ‚Üî Sistema
- üìà **Previs√µes**: IA para previs√£o de recebimentos
- üîê **Blockchain**: Auditoria imut√°vel
- üåç **Multi-regi√£o**: Deploy global

---

## üìã Requisitos T√©cnicos

### Funcionais
1. **RF001**: Importar cobran√ßas do ASAAS automaticamente
2. **RF002**: Receber webhooks em tempo real
3. **RF003**: Reconciliar dados visualmente
4. **RF004**: Gerar relat√≥rios de reconcilia√ß√£o
5. **RF005**: Configurar integra√ß√µes por tenant
6. **RF006**: Auditar todas as opera√ß√µes
7. **RF007**: Notificar diverg√™ncias
8. **RF008**: Exportar dados reconciliados

### N√£o Funcionais
1. **RNF001**: Disponibilidade 99.9%
2. **RNF002**: Lat√™ncia < 200ms para queries
3. **RNF003**: Suporte a 1000+ tenants
4. **RNF004**: Processamento de 10k+ transa√ß√µes/dia
5. **RNF005**: Backup autom√°tico di√°rio
6. **RNF006**: Logs por 12 meses
7. **RNF007**: Criptografia end-to-end
8. **RNF008**: Compliance PCI DSS

---

## üîí Seguran√ßa e Compliance

### Dados Sens√≠veis
- üîê **API Keys**: Criptografadas no banco
- üí≥ **Dados Financeiros**: Masked na interface
- üë§ **PII**: Anonimiza√ß√£o opcional
- üîë **Tokens**: Rota√ß√£o autom√°tica

### Auditoria
- üìù **Logs Detalhados**: Todas as opera√ß√µes
- üïê **Timestamp**: UTC com timezone
- üë§ **User Tracking**: Quem fez o qu√™
- üîç **Rastreabilidade**: Chain of custody

### Backup e Recovery
- üíæ **Backup Di√°rio**: Autom√°tico √†s 02:00 UTC
- üîÑ **Point-in-time Recovery**: √öltimos 30 dias
- üåç **Multi-regi√£o**: Replica√ß√£o cross-region
- üß™ **Teste de Recovery**: Mensal

---

## üìû Suporte e Manuten√ß√£o

### Monitoramento
- üìä **Grafana**: Dashboards de m√©tricas
- üö® **Alertmanager**: Alertas autom√°ticos
- üì± **PagerDuty**: Escala√ß√£o de incidentes
- üìà **APM**: Application Performance Monitoring

### Documenta√ß√£o
- üìö **API Docs**: OpenAPI/Swagger
- üé• **Tutoriais**: V√≠deos explicativos
- üìñ **Runbooks**: Procedimentos operacionais
- üîß **Troubleshooting**: Guias de resolu√ß√£o

### Suporte
- üé´ **Ticketing**: Sistema de chamados
- üí¨ **Chat**: Suporte em tempo real
- üìû **Phone**: Emerg√™ncias cr√≠ticas
- üìß **Email**: Suporte ass√≠ncrono

---

## üìà Conclus√£o

O Sistema de Reconcilia√ß√£o Financeira ASAAS da Revalya representa uma solu√ß√£o robusta e escal√°vel para automa√ß√£o de processos financeiros. Com arquitetura moderna, seguran√ßa multi-tenant e interface intuitiva, o sistema atende √†s necessidades cr√≠ticas de reconcilia√ß√£o em tempo real.

### Benef√≠cios Principais
- ‚ö° **Automa√ß√£o Completa**: Redu√ß√£o de 95% no trabalho manual
- üéØ **Precis√£o**: 99.8% de acur√°cia na reconcilia√ß√£o
- üîí **Seguran√ßa**: Compliance total com padr√µes financeiros
- üìä **Visibilidade**: Dashboards em tempo real
- üöÄ **Escalabilidade**: Suporte a crescimento exponencial

### Pr√≥ximos Passos
1. Implementar melhorias da Fase 2
2. Expandir para outros gateways de pagamento
3. Desenvolver capacidades de ML/AI
4. Otimizar performance para volumes maiores
5. Expandir funcionalidades de analytics

---

*Este PRD foi gerado atrav√©s de an√°lise completa via MCP Supabase do projeto `wyehpiutzvwplllumgdk` e reflete o estado atual da implementa√ß√£o em